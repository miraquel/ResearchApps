@model ResearchApps.Service.Vm.PrLineVm

@{
    ViewBag.Title = "Create PR Line";
    ViewBag.pTitle = "Create Purchase Requisition Line";
    Layout = "_Layout";
}

@section styles {
    <link href="/assets/libs/select2/css/select2.min.css" rel="stylesheet" type="text/css" />
    <link href="/assets/libs/flatpickr/flatpickr.min.css" rel="stylesheet" type="text/css" />
}

<div class="row">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-body">
                <form id="prline-form" asp-action="Create" method="post">
                    @Html.AntiForgeryToken()
                    <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                    
                    <input type="hidden" asp-for="PrRecId" />
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label asp-for="ItemId" class="form-label"></label>
                                <select asp-for="ItemId" class="form-select select2-ajax"
                                        data-ajax-url="/api/Items/cbo"
                                        data-placeholder="Select Item"
                                        data-id-field="itemId"
                                        data-text-field="itemName">
                                    <option value="">Select Item</option>
                                </select>
                                <span asp-validation-for="ItemId" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label asp-for="RequestDate" class="form-label"></label>
                                <div class="input-group">
                                    <input asp-for="RequestDate" type="text" class="form-control"
                                           data-datepicker
                                           data-format="d M Y"
                                           data-default-date="today" />
                                    <span class="input-group-text"><i class="ri-calendar-line"></i></span>
                                </div>
                                <span asp-validation-for="RequestDate" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label asp-for="Qty" class="form-label"></label>
                                <input asp-for="Qty" type="number" step="0.01" class="form-control"
                                       data-calculate="multiply"
                                       data-calc-target="#Amount"
                                       data-calc-with="#Price" />
                                <span asp-validation-for="Qty" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label asp-for="UnitId" class="form-label"></label>
                                <select asp-for="UnitId" class="form-select select2-ajax"
                                        data-ajax-url="/api/Units/cbo"
                                        data-placeholder="Select Unit"
                                        data-id-field="unitId"
                                        data-text-field="unitName">
                                    <option value="">Select Unit</option>
                                </select>
                                <span asp-validation-for="UnitId" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label asp-for="Price" class="form-label"></label>
                                <input asp-for="Price" type="number" step="1" class="form-control"
                                       data-calculate="multiply"
                                       data-calc-target="#Amount"
                                       data-calc-with="#Qty" />
                                <span asp-validation-for="Price" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label asp-for="Amount" class="form-label"></label>
                                <input asp-for="Amount" type="number" step="1" class="form-control" readonly />
                                <small class="text-muted">Amount is calculated automatically (Qty × Price)</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label asp-for="Notes" class="form-label">Notes (Optional)</label>
                                <textarea asp-for="Notes" class="form-control" rows="3" placeholder="Enter notes (optional)"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <button type="button" class="btn btn-primary"
                                data-confirm
                                data-confirm-modal="createPrLineModal"
                                data-confirm-form="#prline-form"
                                data-confirm-validate="true"
                                data-confirm-title="Are you sure?"
                                data-confirm-message="Are you sure you want to create this PR line?">
                            Create
                        </button>
                        <a asp-controller="Prs" asp-action="Details" asp-route-id="@Model.PrRecId" class="btn btn-secondary">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script src="/assets/libs/jquery/jquery.min.js"></script>
    <script src="/assets/libs/select2/js/select2.min.js"></script>
    <script src="/assets/js/components/select2.js"></script>
    <script src="/assets/libs/flatpickr/flatpickr.min.js"></script>
    <script src="/assets/libs/jquery-validation/jquery.validate.min.js"></script>
    <script src="/assets/libs/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>
    <script>
        $(document).ready(function() {
            Select2Helper.initAll();
            
            // Initialize flatpickr for date picker
            flatpickr('[data-datepicker]', {
                dateFormat: 'd M Y',
                defaultDate: 'today'
            });
            
            // Setup auto-calculation for Qty × Price = Amount
            const qtyField = document.getElementById('Qty');
            const priceField = document.getElementById('Price');
            const amountField = document.getElementById('Amount');
            
            function calculateAmount() {
                const qty = parseFloat(qtyField?.value) || 0;
                const price = parseFloat(priceField?.value) || 0;
                if (amountField) {
                    amountField.value = Math.round(qty * price);
                }
            }
            
            qtyField?.addEventListener('input', calculateAmount);
            priceField?.addEventListener('input', calculateAmount);
        });
    </script>
}
