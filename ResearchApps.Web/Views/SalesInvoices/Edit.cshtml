@model ResearchApps.Service.Vm.SalesInvoiceVm

@{
    ViewBag.Title = "Edit Sales Invoice";
    ViewBag.pTitle = $"Edit Sales Invoice {Model.Header.SiId}";
    Layout = "_Layout";
}

<div x-data="siEditForm()" x-init="init()">
    <div class="row">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Edit Sales Invoice - @Model.Header.SiId</h5>
                    <span class="badge bg-info">@Model.Lines.Count() line(s)</span>
                </div>
                <div class="card-body">
                    <form id="si-form" 
                          method="post"
                          action="/SalesInvoices/Edit">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="RecId" value="@Model.Header.RecId" />
                        <input type="hidden" name="SiId" value="@Model.Header.SiId" />
                        
                        <!-- Validation Summary -->
                        <div id="validation-summary" x-show="Object.keys(errors).length > 0" x-cloak>
                            <div class="alert alert-danger">
                                <template x-for="(error, field) in errors" :key="field">
                                    <div x-text="error"></div>
                                </template>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="SiDate" class="form-label">Invoice Date <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <input type="text" 
                                               id="SiDate" 
                                               name="SiDate"
                                               class="form-control"
                                               x-ref="siDatePicker"
                                               data-flatpickr
                                               value="@Model.Header.SiDate.ToString("yyyy-MM-dd")"
                                               :class="{ 'is-invalid': errors.SiDate }"
                                               required />
                                        <span class="input-group-text"><i class="ri-calendar-line"></i></span>
                                    </div>
                                    <div class="invalid-feedback" x-show="errors.SiDate" x-text="errors.SiDate"></div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="CustomerId" class="form-label">Customer <span class="text-danger">*</span></label>
                                    <select class="form-control form-select"
                                            id="CustomerId" 
                                            name="CustomerId"
                                            x-ref="customerSelect"
                                            data-tomselect
                                            data-url="/api/Customers/cbo"
                                            data-selected-value="@Model.Header.CustomerId"
                                            data-selected-text="@Model.Header.CustomerName"
                                            :class="{ 'is-invalid': errors.CustomerId }"
                                            required>
                                        <option value="@Model.Header.CustomerId" selected>@Model.Header.CustomerName</option>
                                    </select>
                                    <div class="invalid-feedback" x-show="errors.CustomerId" x-text="errors.CustomerId"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="PoNo" class="form-label">PO Number</label>
                                    <input type="text" 
                                           id="PoNo" 
                                           name="PoNo"
                                           class="form-control"
                                           value="@Model.Header.PoNo"
                                           placeholder="Enter PO Number" />
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="TaxNo" class="form-label">Tax Number</label>
                                    <input type="text" 
                                           id="TaxNo" 
                                           name="TaxNo"
                                           class="form-control"
                                           value="@Model.Header.TaxNo"
                                           placeholder="Enter Tax Number" />
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label for="Notes" class="form-label">Notes (Optional)</label>
                                    <textarea id="Notes" 
                                              name="Notes"
                                              class="form-control"
                                              rows="2"
                                              placeholder="Enter notes">@Model.Header.Notes</textarea>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Lines Section (Read-only in Edit) -->
                        <div class="card border mt-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="card-title mb-0">Invoice Lines</h6>
                                <span class="badge bg-primary">@Model.Lines.Count() line(s)</span>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-bordered align-middle mb-0">
                                        <thead class="table-light">
                                        <tr>
                                            <th class="text-center" style="width: 50px;">#</th>
                                            <th>DO No</th>
                                            <th>Item</th>
                                            <th class="text-end" style="width: 120px;">Qty</th>
                                            <th style="width: 80px;">Unit</th>
                                            <th class="text-end" style="width: 140px;">Price</th>
                                            <th class="text-end" style="width: 160px;">Amount</th>
                                            <th>Notes</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        @{
                                            var lineNo = 0;
                                            decimal totalAmount = 0;
                                        }
                                        @foreach (var line in Model.Lines)
                                        {
                                            lineNo++;
                                            var lineAmount = line.Qty * line.Price;
                                            totalAmount += lineAmount;
                                            <tr>
                                                <td class="text-center">@lineNo</td>
                                                <td>@line.DoId</td>
                                                <td>@line.ItemName</td>
                                                <td class="text-end">@line.Qty.ToString("N2")</td>
                                                <td>@line.UnitName</td>
                                                <td class="text-end">@line.Price.ToString("N0")</td>
                                                <td class="text-end fw-semibold">@lineAmount.ToString("N0")</td>
                                                <td>@(string.IsNullOrEmpty(line.Notes) ? "-" : line.Notes)</td>
                                            </tr>
                                        }
                                        </tbody>
                                        <tfoot class="table-light">
                                        <tr>
                                            <td colspan="6" class="text-end fw-bold">Total:</td>
                                            <td class="text-end fw-bold text-primary">@totalAmount.ToString("N0")</td>
                                            <td></td>
                                        </tr>
                                        </tfoot>
                                    </table>
                                </div>
                                <div class="alert alert-info mt-3 mb-0">
                                    <i class="ri-information-line me-1"></i>
                                    Lines cannot be modified after creation. To change lines, delete this invoice and create a new one.
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4 d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="ri-save-line me-1"></i> Save
                            </button>
                            <a href="/SalesInvoices/Details/@Model.Header.RecId" class="btn btn-secondary">
                                <i class="ri-arrow-left-line me-1"></i> Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script src="~/js/sales-invoices/si-edit.js"></script>
}
